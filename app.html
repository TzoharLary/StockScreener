<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Screen stocks based on fundamental parameters including P/E ratio, market cap, ROE, and more">
    <title>Stock Screener - Fundamental Analysis Tool</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/landing.css">
    <link rel="stylesheet" href="css/components.css">
</head>
<body>
    <!-- Demo Mode Banner (shown only in demo mode) -->
    <div id="demoBanner" class="demo-banner" style="display: none;">
        <span>üé¨ You're viewing Demo Mode with sample data.</span>
        <a href="#" onclick="switchToFullMode(); return false;">Enter API Key for Full Features</a>
    </div>

    <!-- Welcome Banner (shown only in full mode) -->
    <div id="welcomeBanner" class="welcome-banner" style="display: none;">
        <div class="welcome-text">
            <span>üëã Welcome back!</span>
            <span>API: <span id="maskedApiKey" class="api-key-display"></span></span>
        </div>
        <a href="#" class="settings-link" onclick="openApiKeyModal(); return false;">‚öôÔ∏è Settings</a>
    </div>
    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal-overlay" role="dialog" aria-labelledby="modalTitle" aria-modal="true">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Welcome to Stock Screener</h2>
                <button class="modal-close" onclick="closeApiKeyModal()" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-content">
                <p>To use this application, you'll need a <strong>free API key</strong> from Twelve Data.</p>
                
                <div class="info-box">
                    <p><strong>How to get your free API key:</strong></p>
                    <p>1. Visit <a href="https://twelvedata.com/" target="_blank" rel="noopener noreferrer">twelvedata.com</a></p>
                    <p>2. Sign up for a free account</p>
                    <p>3. Copy your API key from the dashboard</p>
                    <p>4. Paste it below</p>
                    <p style="margin-top: 0.5rem;"><small>Free tier includes 800 API credits per day!</small></p>
                </div>
                
                <div class="modal-input-group">
                    <label for="apiKeyInput">Enter your API key:</label>
                    <input 
                        type="text" 
                        id="apiKeyInput" 
                        placeholder="Your Twelve Data API key"
                        aria-label="API key input"
                        autocomplete="off">
                    <div class="help-text">Your API key will be stored securely in your browser</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="useDemoMode()">Use Demo Mode</button>
                <button class="btn btn-primary" onclick="saveApiKey()">Save API Key</button>
            </div>
        </div>
    </div>

    <!-- Settings Button -->
    <button class="settings-button" onclick="openApiKeyModal()" aria-label="API Key Settings" title="Manage API Key">‚öôÔ∏è</button>

    <!-- Watchlists Button -->
    <button class="watchlists-button" onclick="watchlistManager.showAllWatchlists()" aria-label="My Watchlists" title="Manage Watchlists">
        ‚≠ê
    </button>

    <main class="container">
        <header class="header">
            <h1>Stock Screener</h1>
            <p>Screen stocks based on fundamental parameters</p>
        </header>

        <section class="filter-panel" aria-label="Filter criteria">
            <h2>Filter Criteria</h2>
            
            <!-- Search Section -->
            <div class="search-section">
                <div class="filter-group">
                    <label for="stockSearch">Search by Name or Ticker</label>
                    <div class="autocomplete-container">
                        <input type="text" 
                               id="stockSearch" 
                               placeholder="e.g., Apple, AAPL, Microsoft, TSLA" 
                               autocomplete="off"
                               aria-label="Search stocks by name or ticker symbol"
                               aria-describedby="searchHelp"
                               aria-owns="autocompleteDropdown"
                               aria-autocomplete="list"
                               oninput="handleSearchInput(this.value)"
                               onkeydown="handleSearchKeydown(event)"
                               onfocus="handleSearchFocus()"
                               onblur="handleSearchBlur()">
                        <div id="autocompleteDropdown" 
                             class="autocomplete-dropdown" 
                             role="listbox"
                             aria-label="Stock suggestions">
                            <!-- Autocomplete results will be inserted here -->
                        </div>
                    </div>
                    <span id="searchHelp" class="sr-only">Start typing to search for stocks</span>
                </div>
            </div>
            
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="marketCap">Market Cap (Min)</label>
                    <select id="marketCap">
                        <option value="">Any</option>
                        <option value="small">Small Cap (‚â§ $2B)</option>
                        <option value="mid">Mid Cap ($2B - $10B)</option>
                        <option value="large">Large Cap (‚â• $10B)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="peRatio">P/E Ratio (Max)</label>
                    <input type="number" id="peRatio" placeholder="e.g., 25" step="0.1" min="0">
                </div>

                <div class="filter-group">
                    <label for="peRatioMin">P/E Ratio (Min)</label>
                    <input type="number" id="peRatioMin" placeholder="e.g., 10" step="0.1" min="0">
                </div>

                <div class="filter-group">
                    <label for="pbRatio">P/B Ratio (Max)</label>
                    <input type="number" id="pbRatio" placeholder="e.g., 3" step="0.1" min="0">
                </div>

                <div class="filter-group">
                    <label for="debtToEquity">Debt/Equity (Max)</label>
                    <input type="number" id="debtToEquity" placeholder="e.g., 1.5" step="0.1" min="0">
                </div>

                <div class="filter-group">
                    <label for="roe">ROE (Min %)</label>
                    <input type="number" id="roe" placeholder="e.g., 15" step="0.1">
                </div>

                <div class="filter-group">
                    <label for="revenueGrowth">Revenue Growth (Min %)</label>
                    <input type="number" id="revenueGrowth" placeholder="e.g., 10" step="0.1">
                </div>

                <div class="filter-group">
                    <label for="revenueGrowthYears">Consecutive Years</label>
                    <input type="number" id="revenueGrowthYears" placeholder="e.g., 3" min="1" max="10" step="1">
                </div>

                <div class="filter-group">
                    <label for="sector">Sector</label>
                    <select id="sector">
                        <option value="">All Sectors</option>
                        <option value="Technology">Technology</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Financial">Financial</option>
                        <option value="Consumer">Consumer</option>
                        <option value="Energy">Energy</option>
                        <option value="Industrial">Industrial</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()" aria-label="Apply selected filters">Apply Filters</button>
                <button class="btn btn-secondary" onclick="clearFilters()" aria-label="Clear all filters">Clear All</button>
                <button class="btn btn-secondary" onclick="refreshData()" title="Refresh data from Twelve Data API" aria-label="Refresh stock data from API">Refresh Data</button>
            </div>
        </section>

        <section class="results-section" aria-label="Stock screening results">
            <div class="results-header">
                <h2>Screening Results</h2>
                <div class="results-count" id="resultsCount" role="status" aria-live="polite">Loading...</div>
                <div id="dataSource" style="font-size: 0.9em; color: #666; margin-top: 0.5rem;" role="status" aria-live="polite">
                    Data powered by Twelve Data API
                </div>
            </div>
            <div class="table-container">
                <table class="stock-table" role="table" aria-label="Stock screening results table">
                    <thead>
                        <tr>
                            <th scope="col">Symbol</th>
                            <th scope="col">Company Name</th>
                            <th scope="col">Price</th>
                            <th scope="col">Market Cap</th>
                            <th scope="col">P/E Ratio</th>
                            <th scope="col">P/B Ratio</th>
                            <th scope="col">Debt/Equity</th>
                            <th scope="col">ROE (%)</th>
                            <th scope="col">Sector</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                        <tr>
                            <td colspan="10" class="loading">Loading stock data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Include configuration and modules -->
    <script src="js/storage-service.js"></script>
    <script src="js/watchlist-manager.js"></script>
    <script src="js/stock-details.js"></script>
    <script src="config.js"></script>
    <script src="errors.js"></script>
    <script src="utils.js"></script>
    <script src="api-service.js"></script>
    
    <!-- Application Modules -->
    <script src="js/app-init.js"></script>
    <script src="js/autocomplete.js"></script>
    <script src="js/main-app.js"></script>
    
    <!-- Application Initialization -->
    <script>
        // Initialize services
        const storage = new StorageService();
        const watchlistManager = new WatchlistManager(storage);
        const apiService = new TwelveDataService();
        
        // Initialize app modules
        const mainApp = new MainApp(apiService, storage, watchlistManager);
        const autocomplete = new StockAutocomplete();
        let stockDetailsView = null; // Will be initialized in DOMContentLoaded
        
        const appInitializer = new AppInitializer(storage, () => {
            // Callback when API key changes
            window.apiService = new TwelveDataService();
            mainApp.setApiService(window.apiService);
            autocomplete.setApiService(window.apiService);
            if (stockDetailsView) {
                stockDetailsView.setApiService(window.apiService);
            }
            mainApp.loadStockData();
        });
        
        // Make instances globally available
        window.apiService = apiService;
        window.mainApp = mainApp;
        window.autocomplete = autocomplete;
        window.appInitializer = appInitializer;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Stock Screener initializing with Twelve Data API...');
            console.log('API Key configured:', CONFIG.TWELVE_DATA_API_KEY ? 'Yes' : 'No');
            
            // Initialize stock details view
            stockDetailsView = new StockDetailsView(apiService);
            mainApp.setStockDetailsView(stockDetailsView);
            
            // Set up autocomplete with callbacks
            autocomplete.setApiService(apiService);
            autocomplete.setCallbacks(
                (selectedStock) => mainApp.addStockFromAutocomplete(selectedStock),
                () => mainApp.applyFilters(),
                (selectedStock) => mainApp.showStockDetailsFromAutocomplete(selectedStock)
            );
            
            // Set up event listeners
            appInitializer.setupEventListeners();
            mainApp.setupEventListeners();
            
            // Load stock data from API
            mainApp.loadStockData();
        });
    </script>
</body>
</html>
